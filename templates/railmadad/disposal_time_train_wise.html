{% extends 'railmadad/base.html' %}
{% load customrailmadad %}
{% block body %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src='https://cdn.jsdelivr.net/gh/emn178/chartjs-plugin-labels/src/chartjs-plugin-labels.js '></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
    <style>
#more {display: none;}

.chartBox{
   display: flex;
   width: 100%;
   position: relative;
   bottom: 0px;
}
.colsmall{
   width: 55px;
   margin-bottom: 47px;  
   /* margin-top: 59px; */
   background-color: white; 
   border-right: 2px solid black;
   z-index: 1;
}
.colLarge{
   position: relative;
   right: 22px; 
   width: 100%;
   overflow-x: auto;
}
.box{
   width: 95%;
} 

@media screen and (max-width: 700px){
   .box{
   width: 700px;
   }

   .form-check{
   padding: 0px;
}
}
    </style>
    <form action="/railmadad/disposal_time_train_wise/" method="POST">
        {% csrf_token %}
        <script>
function myFunction() {
  var dots = document.getElementById("dots");
  var moreText = document.getElementById("more");
  var btnText = document.getElementById("myBtn");

  if (dots.style.display === "none") {
    dots.style.display = "inline";
    btnText.innerHTML = "show more"; 
    moreText.style.display = "none";
  } else {
    dots.style.display = "none";
    btnText.innerHTML = "show less"; 
    moreText.style.display = "inline";
  }
}
        </script>
        <center class="center">
            {% include 'railmadad/components/checkbox_js.html' %}
            {% include 'railmadad/components/train_category_comp_withoutMerge.html' %}
            <br />
            <!-- {% include 'railmadad/components/complain_type_comp.html' %} -->
            {% include 'railmadad/components/date_range_comp.html' %}
        </center>
    </form>
    <br />
    <div class="col-xl-10 col-md-12">
        <div class="card">
            <!-- <div class="card-header">
<h4>Railway Data</h4>
<span class="text-muted">This is Graph Show for Railway </span>
</div> -->
            <div class="chart-container">
                <center>
                    <h4>
                        <u>Data Show Graph For <b>Average Disposal Time Train Number Wise</b></u>
                    </h4>
                </center>
                {% if post %}
                    <div class="chartBox">
                        <div class="colsmall">
                            <canvas id="myChart2" height="50px" width="100%"></canvas>
                        </div>
                        <div class="colLarge">
                            <div class="box">
                                <canvas id="myChart" height="50px" width="100%"></canvas>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <br>
                    <center>
                        <h2>Please Add Filters To See Charts</h2>
                    </center>
                {% endif %}
            </div>
        </div>
        <script>

var chart2_yaxes = []
var chart_end =0
var chart_max =0
var chart2_yaxes_asnum = []
var zeroLineIndex = 0

var canvasP = document.getElementById("myChart");
var ctxP = canvasP.getContext('2d');
var myPieChart = new Chart(ctxP, {
   type: 'bar',
   data: {
      labels: [{% for d in train_num %} '{{d}}', {% endfor %}],
      datasets: [{
         label: 'Avg Disposal Time Train Number Wise',
         data: [{% for m in main_data %} {{m|floatconvert}}, {% endfor %}],
         backgroundColor: "red",
         hoverBackgroundColor: "red",
      }]
   },
   options: {
      maintainAspectRatio: false,
      responsive: true,
      // legend: {
      //    display: true,
      //    position: "right"
      // }
      scales: {
        yAxes: [{
                ticks: {
                  display: false,
                  beginAtZero: true,
                },
                gridLines:{
                  drawTicks: false,
                },

                afterFit: (ctx) => {
                  if(myPieChart2){
                    chart2_yaxes = ctx.ticks
                    chart_end = ctx.end
                    chart_max = ctx.max
                    chart2_yaxes_asnum = ctx.ticksAsNumbers
                    zeroLineIndex = ctx.zeroLineIndex
                    myPieChart2.update()
                  }
                }
            }],
            xAxes: [{
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                },
            }],
      }
   }
});

var canvasP2 = document.getElementById("myChart2");
var ctxP2 = canvasP2.getContext('2d');
var myPieChart2 = new Chart(ctxP2, {
   type: 'bar',
   data: {
      labels: [{% for d in train_num %} '{{d}}', {% endfor %}],
      datasets: [{
         label: 'Avg Disposal Time Train Number Wise',
         data: [{% for m in main_data %} {{m|floatconvert}}, {% endfor %}],
         backgroundColor: "red",
         hoverBackgroundColor: "red",
      }]
   },
   options: {
      maintainAspectRatio: false,
      responsive: true,
      legend: {
         display: false,
      },
      scales: {
            xAxes: [{
                ticks: {
                  display: false,
                },
                gridLines:{
                  drawTicks: false,
                }
            }],
            yAxes: [{
              ticks: {
                  beginAtZero: true
                },
                afterFit: (ctx) => {
                  ctx.width = 55;
                  if(chart2_yaxes.length>1){
                    ctx.ticks = chart2_yaxes
                    ctx.end = chart_end
                    ctx.zeroLineIndex = zeroLineIndex
                    ctx.ticksAsNumbers= chart2_yaxes_asnum
                    ctx.max = chart_max
                    // console.log(ctx)
                  }
                }
            }],
        },
        layout: {
        padding: {
          top: 32,
        }
      },
   }
});

canvasP.onclick = function(e) {
   var slice = myPieChart.getElementAtEvent(e);
   if (!slice.length) return; // return if not clicked on slice
   var label = slice[0]._model.label;
   switch (label) {
      {% for d in train_num %}
      case '{{d}}':
         window.open('/railmadad/complain/DISPOSAL_TRAIN_WISE/{{start_date}}/{{end_date}}?complain_type={{complain_type | join:"--"}}&train_number={{d}}&physical_coach_number=')
         break;
      {% endfor %}
   }
}
  
function download() {
    const imageLink = document.createElement('a');
    const canvas = document.getElementById('myChart');

    const tempCanvas = document.createElement('canvas');
    const tempContext = tempCanvas.getContext('2d');

    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    
    tempContext.fillStyle = '#ffffff';
    tempContext.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

    tempContext.drawImage(canvas, 0, 0);
    
    imageLink.download = 'Data.png'
    imageLink.href = tempCanvas.toDataURL('static/data/canvas',1);
    imageLink.click();
  }
  
        </script>
    </div>
</div>
{% endblock %}
