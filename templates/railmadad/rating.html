{% extends 'railmadad/base.html' %}
{% load customrailmadad %}
{% block body %}
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.3.0/chart.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<style>#more {display: none;}</style>
<form action="/railmadad/rating/" method="POST">
    {% csrf_token %}
    <script>
function myFunction() {
  var dots = document.getElementById("dots");
  var moreText = document.getElementById("more");
  var btnText = document.getElementById("myBtn");

  if (dots.style.display === "none") {
    dots.style.display = "inline";
    btnText.innerHTML = "Show more"; 
    moreText.style.display = "none";
  } else {
    dots.style.display = "none";
    btnText.innerHTML = "Show less"; 
    moreText.style.display = "inline";
  }
}
    </script>
    <div class="col-xl-12 col-md-12">
        <div class="card">
            <!-- <div class="card-header">
<h4>Railway Data</h4>
<span class="text-muted">This is Graph Show for Railway </span>
</div> -->
            <br />
            <div class="card-blockk">
                <div id="sales-analytics" style="height:100%;">
                    <div class="chart-container">
                        <center>
                            <h4>
                                <u>Data Show Graph For Railway Complaint Type</u>
                            </h4>
                        </center>
                        <br />
                        <center class="center">
                            {% include 'railmadad/components/rating_train_cat_comp.html' %}
                            <br />
                            <!-- {% include 'railmadad/components/complain_type_comp.html' %} -->
                            <!-- <div class="d-flex justify-content-center align-items-center">
        {% if merge %}
            <input type="checkbox" name="merge-to-satis" id="merge-to-satis" value="True" checked>
        {% else %}    
            <input type="checkbox" name="merge-to-satis" id="merge-to-satis" value="True">
        {% endif %}
        <h5 class="lead my-3">Merge Unrated data to satisfactory</h5>
    </div> -->
                            {% include 'railmadad/components/date_range_comp.html' %}
                        </center>
                    </form>
                    {% if show %}
                        <!-- <div class="my-3 container-fluid d-flex justify-content-center">
    <button class="btn btn-success btn-sm" onClick="download()">Download Data-Graph</button>
  </div> -->
                        <div class="container-fluid col-md-8 d-flex justify-content-center align-items-center">
                            <canvas id="myChart"></canvas>
                        </div>
                    {% else %}
                        <br>
                        <center>
                            <h2>Please add filters to see graph</h2>
                        </center>
                    {% endif %}
                </div>
                <script>
var canvasP = document.getElementById("myChart");
var ctxP = canvasP.getContext('2d');
var totalData = {{total}};

{% if merge %}
    var labelData = ['Unsatisfactory','Satisfactory','Excellent']
{% else %}
var labelData = ['Unsatisfactory','Satisfactory','Excellent', 'Not Rated']
{% endif %}
    

console.log(`TotalData: ${totalData}\nLabelData: ${labelData}`)
var dataMap = new Object();
var chartData = new Array();
var chartLabel = new Array();

for(let i = 0; i<=totalData.length; i++)
{
    dataMap[labelData[i]] = totalData[i]
}

console.log('DataMap: ', dataMap);
var Ent = Object.entries(dataMap).sort((a, b)=> {
    return a[1] < b[1]
})
var len = Object.keys(dataMap).length;

for(let i = 0; i < len; i++)
{
        chartLabel[i] = Ent[i][0];
        chartData[i] = Ent[i][1];
    
}

console.log('Ent ', Ent)
chartLabel.pop()
chartData.pop   ()


var myPieChart = new Chart(ctxP, {
   type: 'bar',
   data: {
      labels: chartLabel,
      datasets: [
        {   
            label:'Rating',
            data: chartData,
            backgroundColor: ["red", "blue", "green", "black"],
            borderColor: ["red", "blue", "green", "black"],
            hoverBackgroundColor: ["red", "blue", "green", "black"]
       }]
   },
   options: {
    maintainAspectRatio: false,
    responsive: true,

    plugins: {
      legend: {
        onClick: (evt, legendItem, legend) => {
          const index = legend.chart.data.labels.indexOf(legendItem.text);
          legend.chart.toggleDataVisibility(index);
          legend.chart.update();
        },
        labels:{
          generateLabels: (chart) => {
            let visibility = [];
            for(let i=0; i<chart.data.labels.length; i++){
              if(chart.getDataVisibility(i) == true){
                visibility.push(false)
              }
              else{
                visibility.push(true)
              }
            };
            return chart.data.labels.map(
              (label , index) => ({
                text: label, 
                strokeStyle: chart.data.datasets[0].borderColor[index],
                fillStyle: chart.data.datasets[0].backgroundColor[index],
                hidden: visibility[index]
              })
            )
          }
        }
      }
    },
  //     scales: {
  //       yAxes: [
  //   {
  //     ticks: {
  //       callback: function (value) { return numberWithCommas(value); },
  //           beginAtZero: true,
  //           userCallback: function(label, index, labels) {
  //               // when the floored value is the same as the value we have a whole number
  //               if (Math.floor(label) === label) {
  //                   return label;
  //               }

  //           },
  //     },
  //   },
  // ],
  //     }

}
});
canvasP.onclick = function(e) {
   var slice = myPieChart.getElementsAtEventForMode(
    e,
    'nearest',
    { intersect: true },
    true
  );
   if (!slice.length) return; // return if not clicked on slice
   var label = myPieChart.data.labels[slice[0].index];
   var merge = false
   {% if merge %}
    merge = true
   {% endif %}
   if (label === 'Not Rated') label = '-1';
   if (label === 'Satisfactory' && merge) label = 'satisfactory-nan';   

   console.log("{{start_date}} to {{end_date}}")
    window.open(`/railmadad/complain/${label}/{{start_date}}/{{end_date}}?complain_type={{complain_type | join:"--"}}&train_number={{train_numbers | join:"-"}}&physical_coach_number=`);
  } 

    
function download(){
  const imageLink = document.createElement('a');
  const canvas = document.getElementById('myChart');

  const tempCanvas = document.createElement('canvas');
  const tempContext = tempCanvas.getContext('2d');

  tempCanvas.width = canvas.width;
  tempCanvas.height = canvas.height;
  
  tempContext.fillStyle = '#ffffff';
  tempContext.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

  tempContext.drawImage(canvas, 0, 0);
  
  imageLink.download = 'Data.png'
  imageLink.href = tempCanvas.toDataURL('static/data/canvas',1);
  imageLink.click();
}
                </script>
                <script>
  $(document).ready(function() {
    $('#select-all-2').click(function() {
        var checked = this.checked;
        $('input[complain="true"]').each(function() {
        this.checked = checked;
    });
    })


    $('#select-critical').click(function() {
        var checked = this.checked;
        $('input[critical="true"]').each(function() {
        this.checked = checked;
    });
    })

    $('#rncc').click(function() {
        var checked = this.checked;
        $('input[rncc="true"]').each(function() {
        this.checked = checked;
    });
    })
    $('#all').click(function() {
        var checked = this.checked;
        $('input[this="true"]').each(function() {
        this.checked = checked;
    });
    })
    $('#rgd').click(function() {
        var checked = this.checked;
        $('input[rgd="true"]').each(function() {
        this.checked = checked;
    });
    })

    $('#dnr').click(function() {
        var checked = this.checked;
        $('input[dnr="true"]').each(function() {
        this.checked = checked;
    });
    })

    $('#pnbe').click(function() {
        var checked = this.checked;
        $('input[pnbe="true"]').each(function() {
        this.checked = checked;
    });
    })

    $('#ppta').click(function() {
        var checked = this.checked;
        $('input[ppta="true"]').each(function() {
        this.checked = checked;
    });
    })

    $('#ipr').click(function() {
        var checked = this.checked;
        $('input[ipr="true"]').each(function() {
        this.checked = checked;
    });
    })

    $('#keu').click(function() {
        var checked = this.checked;
        $('input[keu="true"]').each(function() {
        this.checked = checked;
    });
    })

    $('#mka').click(function() {
        var checked = this.checked;
        $('input[mka="true"]').each(function() {
        this.checked = checked;
    });
    })

    $('#ara').click(function() {
        var checked = this.checked;
        $('input[ara="true"]').each(function() {
        this.checked = checked;
    });
    })
    
});

                </script>
            </div>
        </div>
    </div>
</div>
{% endblock %}
