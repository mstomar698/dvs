{% extends 'cmm/base.html' %}
{% load customcmm %}
{% block body %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
    <script src='https://cdn.jsdelivr.net/gh/emn178/chartjs-plugin-labels/src/chartjs-plugin-labels.js '></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <style>
  #more {
    display: none;
  }
    </style>
    <form action="/cmm/rating_percentage/" method="POST">
        {% csrf_token %}
        <script>
    function myFunction() {
      var dots = document.getElementById("dots");
      var moreText = document.getElementById("more");
      var btnText = document.getElementById("myBtn");

      if (dots.style.display === "none") {
        dots.style.display = "inline";
        btnText.innerHTML = "Show more";
        moreText.style.display = "none";
      } else {
        dots.style.display = "none";
        btnText.innerHTML = "Show less";
        moreText.style.display = "inline";
      }
    }
        </script>
        <div class="col-xl-12 col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4>Railway Data</h4>
                    <span class="text-muted">This is Graph Show for Railway</span>
                </div>
                <div class="card-blockk">
                    <div id="sales-analytics" style="height:100%;">
                        <div class="chart-container">
                            <center>
                                <h4>
                                    <u>Data Show Graph For Railway Complaint Type</u>
                                </h4>
                            </center>
                            <center class="center">
                                {% include 'components/rating_train_cat_comp.html' %}
                                <div class="d-flex justify-content-center align-items-center">
                                    {% if merge %}
                                        <input type="checkbox"
                                               name="merge-to-satis"
                                               id="merge-to-satis"
                                               value="True"
                                               checked>
                                    {% else %}
                                        <input type="checkbox"
                                               name="merge-to-satis"
                                               id="merge-to-satis"
                                               value="True">
                                    {% endif %}
                                    <h5 class="lead my-3">Merge Unrated data to satisfactory</h5>
                                </div>
                                {% include 'components/date_range_comp.html' %}
                            </center>
                        </form>
                        {% if show %}
                            <div class="my-3 container-fluid d-flex justify-content-center">
                                <button class="btn btn-success btn-sm" onClick="download()">Download Data-Graph</button>
                            </div>
                            <div class="container-fluid col-md-8 d-flex justify-content-center align-items-center">
                                <canvas id="myChart" height="55px" width="100%"></canvas>
                            </div>
                        {% else %}
                            <br>
                            <center>
                                <h2>Please add filters to see graph</h2>
                            </center>
                        {% endif %}
                    </div>
                    <script>
  var canvasP = document.getElementById("myChart");
  var ctxP = canvasP.getContext('2d');
  var totalData = {{ total }};

  {% if merge %}
  var labelData = ['Unsatisfactory', 'Satisfactory', 'Excellent']
  {% else %}
  var labelData = ['Unsatisfactory', 'Satisfactory', 'Excellent', 'Not Rated']
  {% endif %}


  console.log(`TotalData: ${totalData}\nLabelData: ${labelData}`)
  var dataMap = new Object();
  var chartData = new Array();
  var chartLabel = new Array();

  for (let i = 0; i <= totalData.length; i++) {
    dataMap[labelData[i]] = totalData[i]
  }

  console.log('DataMap: ', dataMap);
  var Ent = Object.entries(dataMap).sort((a, b) => {
    return a[1] < b[1]
  })
  var len = Object.keys(dataMap).length;

  for (let i = 0; i < len; i++) {
    chartLabel[i] = Ent[i][0];
    chartData[i] = Ent[i][1];

  }

  console.log('Ent ', Ent)
  chartLabel.pop()
  chartData.pop()


  var myPieChart = new Chart(ctxP, {
    type: 'pie',
    data: {
      labels: chartLabel,
      datasets: [
        {   
          {% if not merge %}
            label: ["Unsatisfactory", "Satisfactory", "Excellent", "nan"],
    {% else %}
  label: ["Unsatisfactory", "satisfactory-nan", "Excellent"],
    {% endif %}
  data: chartData,
    backgroundColor: ["red", "blue", "lightgreen", "black"],
      hoverBackgroundColor: ["red", "blue", "lightgreen", "black"]
       }]
   },
  options: {
    responsive: true,
   }
});
  canvasP.onclick = function (e) {
    var slice = myPieChart.getElementAtEvent(e);
    if (!slice.length) return; // return if not clicked on slice
    var label = slice[0]._model.label;
    // alert("you clicked on " + label)
    var merge = false
    {% if merge %}
    merge = true
    {% endif %}
    if (label === 'Not Rated') label = 'nan';
    if (label === 'Satisfactory' && merge) label = 'satisfactory-nan';

    console.log("{{start_date}} to {{end_date}}")
    window.open(`/cmm/complain/${label}/{{start_date}}/{{end_date}}?complain_type=Corruption Bribery--Catering and Vending Services--Divyangjan Facilities--Facilities for Women with Special needs--Coach - Cleanliness--Bed Roll--Security--Punctuality--Water Availability--Electrical Equipment--Medical Assistance--Coach - Maintenance--Miscellaneous--Staff Behaviour&train_number={{checked | join:"-"}}&coach_number=`,);
  }



  function download() {
    const imageLink = document.createElement('a');
    const canvas = document.getElementById('myChart');
    imageLink.download = 'Data.png'
    imageLink.href = canvas.toDataURL('static/data/canvas', 1);
    imageLink.click();
  }
                    </script>
                    <script>
  $(document).ready(function () {
    $('#select-all-2').click(function () {
      var checked = this.checked;
      $('input[complain="true"]').each(function () {
        this.checked = checked;
      });
    })


    $('#select-critical').click(function () {
      var checked = this.checked;
      $('input[critical="true"]').each(function () {
        this.checked = checked;
      });
    })

    $('#rncc').click(function () {
      var checked = this.checked;
      $('input[rncc="true"]').each(function () {
        this.checked = checked;
      });
    })
    $('#all').click(function () {
      var checked = this.checked;
      $('input[this="true"]').each(function () {
        this.checked = checked;
      });
    })
    $('#rgd').click(function () {
      var checked = this.checked;
      $('input[rgd="true"]').each(function () {
        this.checked = checked;
      });
    })

    $('#dnr').click(function () {
      var checked = this.checked;
      $('input[dnr="true"]').each(function () {
        this.checked = checked;
      });
    })

    $('#pnbe').click(function () {
      var checked = this.checked;
      $('input[pnbe="true"]').each(function () {
        this.checked = checked;
      });
    })

    $('#ppta').click(function () {
      var checked = this.checked;
      $('input[ppta="true"]').each(function () {
        this.checked = checked;
      });
    })

    $('#ipr').click(function () {
      var checked = this.checked;
      $('input[ipr="true"]').each(function () {
        this.checked = checked;
      });
    })

    $('#keu').click(function () {
      var checked = this.checked;
      $('input[keu="true"]').each(function () {
        this.checked = checked;
      });
    })

    $('#mka').click(function () {
      var checked = this.checked;
      $('input[mka="true"]').each(function () {
        this.checked = checked;
      });
    })

    $('#ara').click(function () {
      var checked = this.checked;
      $('input[ara="true"]').each(function () {
        this.checked = checked;
      });
    })

  });

                    </script>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
