{% extends 'cmm/base.html' %}
{% load customcmm %}
{% block body %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    {% for message in messages %}
        <div id="alert" class="alert alert-{{ message.tags }}">{{ message }}</div>
        <script type="text/javascript">
  setTimeout(function () {
    $('#alert').alert('close');
  }, 4000);
        </script>
    {% endfor %}
    <style>
  #more {
    display: none;
  }
    </style>
    <form action="/cmm/bottom_train_data_bar_chart/" method="POST">
        {% csrf_token %}
        <center>
            <div class="form-check">
                {% include 'components/train_category_comp.html' %}
                <script>
        function myFunction() {
          var dots = document.getElementById("dots");
          var moreText = document.getElementById("more");
          var btnText = document.getElementById("myBtn");

          if (dots.style.display === "none") {
            dots.style.display = "inline";
            btnText.innerHTML = "Show more";
            moreText.style.display = "none";
          } else {
            dots.style.display = "none";
            btnText.innerHTML = "Show less";
            moreText.style.display = "inline";
          }
        }
                </script>
                <center class="center">
                    {% include 'components/complain_type_comp.html' %}
                    {% include 'components/date_range_comp.html' %}
                </center>
            </form>
            <br>
            <div class="col-xl-12 col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h4>Railway Data</h4>
                        <span class="text-muted">This is Graph Show for Railway</span>
                    </div>
                    <div class="card-blockk">
                        <div id="sales-analytics" style="height:100%;">
                            <div class="chart-container">
                                <center>
                                    <h4>
                                        <u>Data Show Graph For Bottom {{ train_count }} Trains Complaint Wise</u>
                                    </h4>
                                </center>
                                <div class="my-3 container-fluid d-flex justify-content-center">
                                    <button class="btn btn-success btn-sm" onClick="download()">Download Data-Graph</button>
                                </div>
                                <canvas id="myChart" height="57px" width="100%"></canvas>
                                <br>
                                <script>
            var canvasP = document.getElementById("myChart");
            var ctxP = canvasP.getContext('2d');
            var labelData = [{% for m in bottom_train %}'{{m}}', {% endfor %}];
            var totalData = {{ bottom_data_count }};
            var dataMap = new Object();
            var chartData = new Array();
            var chartLabel = new Array();

            for (let i = 0; i <= totalData.length; i++) {
              dataMap[labelData[i]] = totalData[i]
            }


            var Ent = Object.entries(dataMap).sort((a, b) => {
              return a[1] < b[1]
            })

            console.log('Ent: ', Ent);
            var len = Object.keys(dataMap).length;

            for (let i = 0; i < len; i++) {
                chartLabel[i] = Ent[i][0];
                chartData[i] = parseInt(Ent[i][1]);
            }
            chartLabel.pop()
            chartData.pop()
            var myPieChart = new Chart(ctxP, {
              type: 'bar',
              data: {
                labels: chartLabel,
                datasets: [
                  {
                    data: chartData,
                    backgroundColor: [{% for m in bottom_train %}"#FF3838", "#C3792B", "#2196F3", "#A70101", "#36A701", "#0148A7", "#2BC3BA", "#8C006C", "#828C00", "#00838C", {% endfor %}],
              hoverBackgroundColor: ["#FF3838", "#C3792B", "#2196F3", "#A70101", "#36A701", "#0148A7", "#2BC3BA", "#8C006C", "#828C00", "#00838C"]
            }]
   },
            options: {
              legend: {
                display: true,
                  position: "top"
              },

            }
});

            canvasP.onclick = function (e) {
              var slice = myPieChart.getElementAtEvent(e);
              if (!slice.length) return; // return if not clicked on slice
              var label = slice[0]._model.label;
              switch (label) {
      // add case for each label/slice
      {% for p_t in bottom_train %}
      {% if start_date == "None" or start_date == None %}
      case '{{p_t}}':
         window.open('/cmm/complain/{{p_t}}/2000-01-01/5000-01-01?complain_type=Corruption Bribery--Catering and Vending Services--Divyangjan Facilities--Facilities for Women with Special needs--Coach - Cleanliness--Bed Roll--Security--Punctuality--Water Availability--Electrical Equipment--Medical Assistance--Coach - Maintenance--Miscellaneous--Staff Behaviour&train_number={{p_t}}&coach_number=');
         break;
      {% else %}
      case '{{p_t}}':
         window.open('/cmm/complain/{{p_t}}/{{start_date}}/{{end_date}}?complain_type={{complain_type | join:"--"}}&train_number={{p_t}}&coach_number=');
         break;
      {% endif %}
      {% endfor %}
   }

}


            function download() {
              const imageLink = document.createElement('a');
              const canvas = document.getElementById('myChart');
              imageLink.download = 'Data.png'
              imageLink.href = canvas.toDataURL('media/data/canvas', 1);
              // window.open(imageLink);
              // document.write('<img src=" '+imageLink+' " />')

              // console.log(imageLink.href);
              imageLink.click();
            }

            $(document).ready(function () {
              $('#select-all-2').click(function () {
                var checked = this.checked;
                $('input[complain="true"]').each(function () {
                  this.checked = checked;
                });
              })


              $('#select-critical').click(function () {
                var checked = this.checked;
                $('input[critical="true"]').each(function () {
                  this.checked = checked;
                });
              })

              $('#rncc').click(function () {
                var checked = this.checked;
                $('input[rncc="true"]').each(function () {
                  this.checked = checked;
                });
              })
              $('#all').click(function () {
                var checked = this.checked;
                $('input[this="true"]').each(function () {
                  this.checked = checked;
                });
              })
              $('#rgd').click(function () {
                var checked = this.checked;
                $('input[rgd="true"]').each(function () {
                  this.checked = checked;
                });
              })

              $('#dnr').click(function () {
                var checked = this.checked;
                $('input[dnr="true"]').each(function () {
                  this.checked = checked;
                });
              })

              $('#pnbe').click(function () {
                var checked = this.checked;
                $('input[pnbe="true"]').each(function () {
                  this.checked = checked;
                });
              })

              $('#ppta').click(function () {
                var checked = this.checked;
                $('input[ppta="true"]').each(function () {
                  this.checked = checked;
                });
              })

              $('#ipr').click(function () {
                var checked = this.checked;
                $('input[ipr="true"]').each(function () {
                  this.checked = checked;
                });
              })

              $('#keu').click(function () {
                var checked = this.checked;
                $('input[keu="true"]').each(function () {
                  this.checked = checked;
                });
              })

              $('#mka').click(function () {
                var checked = this.checked;
                $('input[mka="true"]').each(function () {
                  this.checked = checked;
                });
              })

              $('#ara').click(function () {
                var checked = this.checked;
                $('input[ara="true"]').each(function () {
                  this.checked = checked;
                });
              })

            });

                                </script>
                                {% include 'components/checkbox_js.html' %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endblock %}
