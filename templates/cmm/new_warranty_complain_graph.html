{% extends 'cmm/base.html' %}
{% load customcmm %}
{% load static %}
<style>
.card {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-radius: 6px;
    background-color: #ffffff;
    padding: 20px;
    margin-bottom: 20px;
}

.card-header {
    display: flex;
    flex-direction: column;
    align-items: center;
}

h4 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: bold;
}

.empty-message,
.data-message {
    font-size: 1rem;
    margin-bottom: 10px;
}

@media (max-width: 767px) {
    /* For mobile devices */
    h4 {
        font-size: 1.2rem;
    }

    .empty-message,
    .data-message {
        font-size: 0.9rem;
    }
}

@media (min-width: 768px) {
    /* For tablets and larger screens */
    h4 {
        font-size: 1.8rem;
    }

    .empty-message,
    .data-message {
        font-size: 1.1rem;
    }
}

</style>
{% block breadcrum %}
    <li class="breadcrumb-item">
        <a href="/">
            <i class="fa fa-home"></i></a>
    </li>
    <li class="breadcrumb-item">See The Data</li>
    <li class="breadcrumb-item">
        <a href="/cmm/new_warranty_complain_graph/">New Warranty Complain Graph</a>
    </li>
{% endblock %}
{% block body %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    {% include 'cmm/components_warranty/new_warranty_complain_graph_filters.html' %}
    <div class="card card-header bg-light my-3">
        {% if method == 'POST' %}
            <center>
                <div class="btn-group border mb-3" role="group" aria-label="Basic example">
                    <button type="button" class="btn btn-success" id="show-chart">Show Chart</button>
                    <button type="button" class="btn btn-success" id="show-table">Show Table</button>
                </div>
            </center>
        {% endif %}
        <div class="col-xl-12 col-md-12 my-3">
            <div class="card" id="card_download">
                <div class="card-header" id="sick-chart">
                    <h4>CMM DATA</h4>
                    {% if method == 'GET' %}
                        <span class="empty-message">Please select filters to add render charts.</span>
                    {% else %}
                        <span class="data-message">Showing data for Number of times a coach was sick.</span>
                        <center>
                            <button class="btn btn-primary btn-sm" id="download" onclick="download()">Download Chart</button>
                        </center>
                        <canvas id="chart"></canvas>
                    {% endif %}
                </div>
                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                <script>
    // $(document).ready(function() {
    //     // Function to set canvas dimensions based on container size
    //     function setCanvasSize() {
    //         var container = $('.chart-container');
    //         var canvas = document.getElementById('chart');
    //         canvas.width = container.width();
    //         canvas.height = container.height();
            
    //         // Call your chart rendering function here or update the chart if you're using a library like Chart.js
    //         // For example: renderChart();
    //     }

    //     // Call the function initially and whenever the window is resized
    //     setCanvasSize();
    //     $(window).resize(function() {
    //         setCanvasSize();
    //     });
    // });
                </script>
                <div class="card-header" id="sick-table" style="display: none;">
                    <h4>CMM DATA</h4>
                    {% if method == 'GET' %}
                        <span class="">Please select filters to add render charts.</span>
                    {% else %}
                        <span class="">Showing data for Number of times a coach was sick.</span>
                        <center>
                            <button class="btn btn-primary btn-sm" id="download-button">Download Table</button>
                        </center>
                        <center class="my-4">
                            <h4>
                                <u>Showing result for {{ length }} coaches.</u>
                            </h4>
                        </center>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead class="thead">
                                    <tr>
                                        <th scope="col">Sr. No.</th>
                                        <th scope="col">
                                            <span>
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <span>Coach Number</span>
                                                    <i class="fa fa-sort"></i>
                                                </div>
                                            </span>
                                        </th>
                                        <th scope="col">
                                            <span>
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <span>Number of complains</span>
                                                    <i class="fa fa-sort"></i>
                                                </div>
                                            </span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in result %}
                                        <tr>
                                            <th scope="row">{{ forloop.counter }}</th>
                                            <td>
                                                <span class="d-inline-block"
                                                      tabindex="0"
                                                      data-toggle="tooltip"
                                                      title="Show {{ entry | get_2d_1 }} entries for coach {{ entry | get_2d_0 }}">
                                                    <a target="_blank"
                                                       class="data"
                                                       href='/cmm/new_complain_warranty/{{ entry | get_2d_0 }}/{{ complain_start }}/{{ complain_end }}?failed_assembly={{ checked_failed_data | join:"---" }}&complaint_id={{ checked_complain_data | join:"-" }}'>
                                                        {{ entry| get_2d_0 }}
                                                    </a>
                                                </span>
                                            </td>
                                            <td>
                                                <span class="d-inline-block"
                                                      tabindex="0"
                                                      data-toggle="tooltip"
                                                      title="Show {{ entry | get_2d_1 }} entries for coach {{ entry | get_2d_0 }} ">
                                                    <a target="_blank"
                                                       class="data"
                                                       href='/cmm/new_complain_warranty/{{ entry | get_2d_0 }}/{{ complain_start }}/{{ complain_end }}?failed_assembly={{ checked_failed_data | join:"---" }}&complaint_id={{ checked_complain_data | join:"-" }}'>
                                                        {{ entry| get_2d_1 }}
                                                    </a>
                                                </span>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% if method == 'POST' %}
    <script>

  $(document).ready(function () {
    $('#show-chart').click(function () {
      $('#sick-chart').show();
      $('#sick-table').hide();
    });

    $('#show-table').click(function () {
      $('#sick-chart').hide();
      $('#sick-table').show();
    });
  })
  
  const chart = document.getElementById('chart')
  var ctx = document.getElementById('chart').getContext('2d');
  const data = {
    labels: [{% for l in labels %} '{{l}}', {% endfor %}],
  datasets: [{
    label: 'Number of complaints of coaches with respect to different failed-assembly',
    backgroundColor: 'rgb(255,50, 50)',
    borderColor: 'rgb(255, 99, 132)',
    data: [{% for t in data %}'{{t}}', {% endfor %}],
    }]
  };

  const config = {
    type: 'bar',
    data: data,
    options: {
      animation: false,
      scales: {
        yAxes: [{
          ticks: {
            beginAtZero: true,
            fixedStepSize: 1,
          },
          scaleLabel: {
            display: true,
            labelString: 'No. of times a complaint is registered',
          }
        }],

        xAxes: [{
          scaleLabel: {
            display: true,
            labelString: 'Coach Number'
          }
        }]
      }
    }
  };

  const myChart = new Chart(
    ctx,
    config
  );

  chart.onclick = function (e) {
    console.log('clicked');
    var slice = myChart.getElementAtEvent(e);
    if (!slice.length) return; 
    var label = slice[0]._model.label;
    window.open(`/cmm/new_complain_warranty/${label}/{{complain_start}}/{{complain_end}}?failed_assembly={{checked_failed_data | join:"---"}}&complaint_id={{checked_complain_data | join:"-"}}&`);
  }

  function download() {
    const imageLink = document.createElement('a');
    const canvas = document.getElementById('chart');
    imageLink.download = 'new_warranty_Complain_graph.png';
    imageLink.href = canvas.toDataURL('media/data/canvas', 1);
    imageLink.click();
  }


  document.getElementById("download-button").addEventListener("click", function () {
    console.log("clicked")
    var html = document.querySelector("table").outerHTML;
    htmlToCSV(html, "new_warranty_complain_chart_data.csv");
  });
  function htmlToCSV(html, filename) {
    var data = [];
    var rows = document.querySelectorAll("table tr");
    for (var i = 0; i < rows.length; i++) {
      var row = [], cols = rows[i].querySelectorAll("td, th");
      for (var j = 0; j < cols.length; j++) {
        console.log(cols[j].innerText);
        row.push(cols[j].innerText);
      }
      data.push(row.join("---").replaceAll(",", " ").split("---").join(", "));
    }

    downloadCSVFile(data.join("\n"), filename);

  }

  function downloadCSVFile(csv, filename) {
    var csv_file, download_link;
    csv_file = new Blob([csv], { type: "text/csv" });
    download_link = document.createElement("a");
    download_link.download = filename;
    download_link.href = window.URL.createObjectURL(csv_file);
    download_link.style.display = "none";
    document.body.appendChild(download_link);
    download_link.click();
    // document.getElementById("download-button").innerText = "Download"

  }

    </script>
{% endif %}
{% endblock %}
